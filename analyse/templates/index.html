<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 2rem; background-color: #f8f9fa; }
        .table-responsive { max-height: 75vh; }
        th, td { white-space: nowrap; font-size: 0.8rem; vertical-align: middle;}
        .table-hover tbody tr {
            transition: background-color 0.15s ease-in-out;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        h2 {
            color: #343a40;
        }

        /* Custom Popover Style */
        #custom-popover {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            top: 80px;
            right: 25px;
            width: 450px;
            z-index: 1080;
            border-radius: 0.8rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.08);
            background-color: #fff;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, visibility 0.2s;
            transform: translateX(20px);
        }
        #custom-popover.is-visible {
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }
        #custom-popover .popover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            margin-bottom: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #212529;
            background-color: #f7f7f7;
            border-bottom: 1px solid #dee2e6;
            border-top-left-radius: 0.8rem;
            border-top-right-radius: 0.8rem;
            cursor: grab;
        }
        #custom-popover .popover-body {
            padding: 1.25rem;
            color: var(--bs-body-color);
        }
        #custom-popover .popover-body dl {
            font-size: 0.8rem;
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 0;
        }
        #custom-popover .popover-body dt {
            font-weight: 500;
        }
        #custom-popover .popover-body dd {
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="card mt-4 shadow-sm">
            <div class="card-header"><h2>商品数据 (Products)</h2></div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="products-search-input" class="form-control" placeholder="通过 Promotion ID, Product ID, 或标题搜索...">
                            <button id="products-search-btn" class="btn btn-primary">搜索</button>
                            <button id="products-clear-btn" class="btn btn-outline-secondary">清空</button>
                        </div>
                    </div>
                </div>
                <div id="products-table-container" class="table-responsive"></div>
                <nav id="products-pagination" class="mt-3 d-flex justify-content-center"></nav>
            </div>
        </div>
        <div class="card mt-4 shadow-sm">
            <div class="card-header"><h2>推广数据 (Promotion Data)</h2></div>
            <div class="card-body">
                <div id="promotion-data-table-container" class="table-responsive"></div>
                <nav id="promotion-data-pagination" class="mt-3 d-flex justify-content-center"></nav>
            </div>
        </div>
    </div>

    <!-- Custom Popover Element -->
    <div id="custom-popover" role="tooltip">
        <div class="popover-header">
            <span id="popover-title"></span>
            <button type="button" class="btn-close" id="popover-close" aria-label="Close"></button>
        </div>
        <div class="popover-body"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const perPage = 30;
            if (!window.popoverCache) window.popoverCache = {};
            const customPopover = document.getElementById('custom-popover');
            
            const productSearchInput = document.getElementById('products-search-input');
            const productSearchBtn = document.getElementById('products-search-btn');
            const productClearBtn = document.getElementById('products-clear-btn');

            // Make popover draggable
            const popoverHeader = customPopover.querySelector('.popover-header');
            let isDragging = false;
            let dragOffsetX, dragOffsetY;

            popoverHeader.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only drag with left mouse button
                e.preventDefault();
                isDragging = true;

                const popoverRect = customPopover.getBoundingClientRect();
                dragOffsetX = e.clientX - popoverRect.left;
                dragOffsetY = e.clientY - popoverRect.top;

                customPopover.style.right = 'auto';
                customPopover.style.transform = 'none';
                
                popoverHeader.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onDragMouseMove);
                document.addEventListener('mouseup', onDragMouseUp);
            });

            function onDragMouseMove(e) {
                if (!isDragging) return;

                let newX = e.clientX - dragOffsetX;
                let newY = e.clientY - dragOffsetY;

                const maxX = window.innerWidth - customPopover.offsetWidth;
                const maxY = window.innerHeight - customPopover.offsetHeight;

                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));

                customPopover.style.left = `${newX}px`;
                customPopover.style.top = `${newY}px`;
            }

            function onDragMouseUp() {
                isDragging = false;
                popoverHeader.style.cursor = 'grab';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', onDragMouseMove);
                document.removeEventListener('mouseup', onDragMouseUp);
            }

            // Initial Load
            loadTable('products', 1, perPage);
            loadTable('promotion_data', 1, perPage);

            // Event Listeners
            document.getElementById('popover-close').addEventListener('click', () => {
                customPopover.classList.remove('is-visible');
                document.querySelectorAll('tbody tr.table-primary').forEach(r => r.classList.remove('table-primary'));
            });

            productSearchBtn.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.trim();
                loadTable('products', 1, perPage, searchTerm);
            });

            productSearchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    productSearchBtn.click();
                }
            });

            productClearBtn.addEventListener('click', () => {
                productSearchInput.value = '';
                loadTable('products', 1, perPage, '');
            });

            function loadTable(tableName, page, perPage, searchTerm = '') {
                const elementIdBase = tableName.replace(/_/g, '-');
                const tableContainer = document.getElementById(`${elementIdBase}-table-container`);
                if (!tableContainer) return;

                tableContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                let apiUrl = `/api/${tableName}?page=${page}&per_page=${perPage}`;
                if (searchTerm && tableName === 'products') {
                    apiUrl += `&search=${encodeURIComponent(searchTerm)}`;
                }

                fetch(apiUrl)
                    .then(response => response.ok ? response.json() : Promise.reject(new Error(`HTTP error! status: ${response.status}`)))
                    .then(result => {
                        const { columns, data, total_pages, error } = result;
                        const paginationContainer = document.getElementById(`${elementIdBase}-pagination`);

                        if (error) {
                            throw new Error(error);
                        }

                        if (!data || data.length === 0) {
                            if (searchTerm) {
                                tableContainer.innerHTML = `<p class="text-center text-muted p-5">未找到与 \"${escapeHtml(searchTerm)}\" 相关的商品。</p>`;
                            } else {
                                tableContainer.innerHTML = '<p class="text-center text-muted p-5">没有数据</p>';
                            }
                            paginationContainer.innerHTML = '';
                            return;
                        }

                        let tableHtml = '<table class="table table-bordered table-striped table-hover">';
                        tableHtml += '<thead class="table-dark" style="position: sticky; top: 0; z-index: 1;"><tr>';
                        columns.forEach(col => { tableHtml += `<th>${col.replace(/_/g, ' ')}</th>`; });
                        tableHtml += '</tr></thead><tbody>';

                        data.forEach(row => {
                            tableHtml += `<tr data-date="${row.date}" data-product-id="${row.product_id}" data-promotion-id="${row.promotion_id}">`;
                            columns.forEach(col => {
                                let value = row[col];
                                if (value === null || value === undefined) value = '';
                                if ((col === 'cover' || col === '封面') && typeof value === 'string' && value.startsWith('http')) {
                                    value = `<a href="${value}" target="_blank" title="点击查看大图"><img src="${value}" alt="cover" height="40"></a>`;
                                } else if (typeof value === 'string' && value.startsWith('http')) {
                                    value = `<a href="${value}" target="_blank" title="${escapeHtml(value)}">${escapeHtml(value.substring(0, 30))}...</a>`;
                                } else if (typeof value === 'string' && value.length > 40) {
                                    value = `<span title="${escapeHtml(value)}">${escapeHtml(value.substring(0, 40))}...</span>`;
                                }
                                tableHtml += `<td>${value}</td>`;
                            });
                            tableHtml += '</tr>';
                        });
                        tableHtml += '</tbody></table>';
                        tableContainer.innerHTML = tableHtml;

                        buildPagination(tableName, paginationContainer, page, total_pages, perPage, searchTerm);
                        initializeRowClickListeners(tableContainer, tableName);
                    })
                    .catch(error => {
                        console.error(`Error loading ${tableName}:`, error);
                        tableContainer.innerHTML = `<p class="text-danger text-center p-5">加载数据失败: ${error.message}</p>`;
                    });
            }

            function initializeRowClickListeners(tableContainer, tableName) {
                const popoverTitle = document.getElementById('popover-title');
                const popoverBody = customPopover.querySelector('.popover-body');
                const rows = tableContainer.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    row.addEventListener('click', () => {
                        document.querySelectorAll('tbody tr.table-primary').forEach(r => r.classList.remove('table-primary'));
                        row.classList.add('table-primary');

                        popoverTitle.textContent = '关联数据';
                        popoverBody.innerHTML = '<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                        customPopover.classList.add('is-visible');

                        const rowData = row.dataset;
                        const targetTable = tableName === 'products' ? 'promotion_data' : 'products';
                        const targetApi = `/api/${targetTable}_item`;
                        const cacheKey = `${rowData.date}-${rowData.productId}-${rowData.promotionId}-${targetTable}`;

                        if (window.popoverCache[cacheKey]) {
                            popoverTitle.textContent = `关联 ${targetTable.replace(/_/g, ' ')} 数据`;
                            popoverBody.innerHTML = window.popoverCache[cacheKey];
                            return;
                        }

                        const params = new URLSearchParams({ date: rowData.date, product_id: rowData.productId, promotion_id: rowData.promotionId });

                        fetch(`${targetApi}?${params.toString()}`)
                            .then(response => response.ok ? response.json() : Promise.reject(new Error(`HTTP ${response.status}`)))
                            .then(itemData => {
                                if (itemData.error) throw new Error(itemData.error);

                                let contentHtml = '<dl class="row">';
                                for (const [key, value] of Object.entries(itemData)) {
                                    if (value !== null && value !== '' && key !== 'creation_time') {
                                        let displayValue = escapeHtml(String(value));
                                        if (String(value).startsWith('http')) {
                                            displayValue = `<a href="${value}" target="_blank">link</a>`;
                                        }
                                        contentHtml += `<dt class="col-sm-4 text-truncate" title="${key.replace(/_/g, ' ')}">${key.replace(/_/g, ' ')}</dt><dd class="col-sm-8">${displayValue}</dd>`;
                                    }
                                }
                                contentHtml += '</dl>';
                                
                                window.popoverCache[cacheKey] = contentHtml;
                                popoverTitle.textContent = `关联 ${targetTable.replace(/_/g, ' ')} 数据`;
                                popoverBody.innerHTML = contentHtml;
                            })
                            .catch(err => {
                                popoverTitle.textContent = '错误';
                                popoverBody.innerHTML = `<div class="text-danger p-3">加载失败: ${err.message}</div>`;
                            });
                    });
                });
            }

            function buildPagination(tableName, container, currentPage, totalPages, perPage, searchTerm = '') {
                container.innerHTML = '';
                if (totalPages <= 1) return;
                const ul = document.createElement('ul');
                ul.className = 'pagination';
                const createPageItem = (text, pageNum, isDisabled = false, isActive = false) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.innerText = text;
                    if (!isDisabled) {
                        a.addEventListener('click', (e) => { e.preventDefault(); loadTable(tableName, pageNum, perPage, searchTerm); });
                    }
                    li.appendChild(a);
                    return li;
                };
                ul.appendChild(createPageItem('上一页', currentPage - 1, currentPage === 1));
                let startPage = Math.max(1, currentPage - 2), endPage = Math.min(totalPages, currentPage + 2);
                if (startPage > 1) {
                    ul.appendChild(createPageItem('1', 1));
                    if (startPage > 2) ul.appendChild(createPageItem('...', 0, true));
                }
                for (let i = startPage; i <= endPage; i++) {
                    ul.appendChild(createPageItem(i, i, false, i === currentPage));
                }
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) ul.appendChild(createPageItem('...', 0, true));
                    ul.appendChild(createPageItem(totalPages, totalPages));
                }
                ul.appendChild(createPageItem('下一页', currentPage + 1, currentPage === totalPages));
                container.appendChild(ul);
            }

            function escapeHtml(unsafe) {
                if (unsafe === null || unsafe === undefined) return '';
                return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html>