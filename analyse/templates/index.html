<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 2rem; background-color: #f8f9fa; }
        .table-responsive { max-height: 75vh; }
        th, td { white-space: nowrap; font-size: 0.8rem; vertical-align: middle;}
        .table-hover tbody tr {
            transition: background-color 0.15s ease-in-out;
        }
        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        h2 {
            color: #343a40;
        }

        /* Custom Popover Style */
        #custom-popover {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            top: 0;
            right: 0;
            width: 450px;
            z-index: 1080;
            border-radius: 0.8rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border: 1px solid rgba(0,0,0,0.08);
            background-color: #fff;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, visibility 0.2s;
            transform: translateX(20px);
        }
        #custom-popover.is-visible {
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }
        #custom-popover .popover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            margin-bottom: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #212529;
            background-color: #f7f7f7;
            border-bottom: 1px solid #dee2e6;
            border-top-left-radius: 0.8rem;
            border-top-right-radius: 0.8rem;
            cursor: grab;
        }
        #custom-popover .popover-body {
            padding: 1.25rem;
            color: var(--bs-body-color);
        }
        #custom-popover .popover-body dl {
            font-size: 0.8rem;
            max-height: 60vh;
            overflow-y: auto;
            margin-bottom: 0;
        }
        #custom-popover .popover-body dt {
            font-weight: 500;
        }
        #custom-popover .popover-body dd {
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="card mt-4 shadow-sm">
            <div class="card-header"><h2>商品数据 (Products)</h2></div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="products-search-input" class="form-control" placeholder="通过 Promotion ID, Product ID, 或标题搜索...">
                            <button id="products-search-btn" class="btn btn-primary">搜索</button>
                            <button id="products-clear-btn" class="btn btn-outline-secondary">清空</button>
                        </div>
                    </div>
                </div>
                <div id="products-table-container" class="table-responsive"></div>
                <nav id="products-pagination" class="mt-3 d-flex justify-content-center"></nav>
            </div>
        </div>
        <div class="card mt-4 shadow-sm">
            <div class="card-header"><h2>推广数据 (Promotion Data)</h2></div>
            <div class="card-body">
                <div id="promotion-data-table-container" class="table-responsive"></div>
                <nav id="promotion-data-pagination" class="mt-3 d-flex justify-content-center"></nav>
            </div>
        </div>
    </div>

    <!-- Custom Popover Element -->
    <div id="custom-popover" role="tooltip">
        <div class="popover-header">
            <span id="popover-title"></span>
            <button type="button" class="btn-close" id="popover-close" aria-label="Close"></button>
        </div>
        <div class="popover-body"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const perPage = 30;
            if (!window.popoverCache) window.popoverCache = {};
            const customPopover = document.getElementById('custom-popover');
            
            const productSearchInput = document.getElementById('products-search-input');
            const productSearchBtn = document.getElementById('products-search-btn');
            const productClearBtn = document.getElementById('products-clear-btn');

            const columnTranslations = {
                'products': {
                    'date': '日期',
                    'product_id': '产品ID',
                    'promotion_id': '促销ID',
                    'category': '商品类目',
                    'title': '商品标题',
                    'cover': '封面',
                    'rank': '排名',
                    'sold': '已售',
                    'douyin_share_text': '抖音分享文本',
                    'juliang_url': '巨量URL',
                    'douyin_url': '抖音URL',
                    'price': '到手价',
                    'commission_rate': '佣金率',
                    'good_review_rate': '好评率',
                    'influencer_count': '带货人数',
                    'shop_experience_score': '店铺体验分',
                    'product_score': '商品分',
                    'logistics_score': '物流分',
                    'seller_score': '商家分',
                    'shop_name': '店铺名',
                    'source_json_filename': '来源JSON',
                    'creation_time': '创建时间'
                },
                'promotion_data': {
                    'date': '日期',
                    'product_id': '产品ID',
                    'promotion_id': '促销ID',
                    'time_range': '时间范围',
                    'category': '商品类目',
                    'type': '类型',
                    'total_sales_amount': '总销售额',
                    'total_sales_amount_formatted': '总销售额(格式化)',
                    'window_sales': '橱窗销量',
                    'window_sales_formatted': '橱窗销量(格式化)',
                    'image_text_sales': '图文销量',
                    'image_text_sales_formatted': '图文销量(格式化)',
                    'live_sales': '直播销量',
                    'live_sales_formatted': '直播销量(格式化)',
                    'video_sales': '视频销量',
                    'video_sales_formatted': '视频销量(格式化)',
                    'converting_influencers': '出单达人数',
                    'converting_contents': '出单内容数',
                    'order_conversion_rate': '下单转化率',
                    'order_conversion_rate_formatted': '下单转化率(格式化)',
                    'views': '视频浏览量',
                    'video_sales_ratio': '视频销量占比',
                    'video_view_sales_ratio': '视频浏览销售比',
                    'source_json_filename': '来源JSON',
                    'creation_time': '创建时间'
                },
                'promotion_data_detail': {
                    'date': '日期',
                    'product_id': '产品ID',
                    'promotion_id': '促销ID',
                    'calculate_time': '计算时间',
                    'sales': '销量',
                    'pv': '浏览量',
                    'match_num': '匹配数',
                    'order_conversion_rate': '下单转化率',
                    'sales_amount': '销售额',
                    'sales_content_num': '销售内容数',
                    'match_order_num': '匹配订单数',
                    'format_order_conversion_rate': '下单转化率(格式化)',
                    'format_sales_amount': '销售额(格式化)',
                    'creation_time': '创建时间'
                }
            };

            // Make popover draggable
            const popoverHeader = customPopover.querySelector('.popover-header');
            let isDragging = false;
            let dragOffsetX, dragOffsetY;

            popoverHeader.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; // Only drag with left mouse button
                e.preventDefault();
                isDragging = true;

                const popoverRect = customPopover.getBoundingClientRect();
                dragOffsetX = e.clientX - popoverRect.left;
                dragOffsetY = e.clientY - popoverRect.top;

                customPopover.style.right = 'auto';
                customPopover.style.transform = 'none';
                
                popoverHeader.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';

                document.addEventListener('mousemove', onDragMouseMove);
                document.addEventListener('mouseup', onDragMouseUp);
            });

            function onDragMouseMove(e) {
                if (!isDragging) return;

                let newX = e.clientX - dragOffsetX;
                let newY = e.clientY - dragOffsetY;

                const maxX = window.innerWidth - customPopover.offsetWidth;
                const maxY = window.innerHeight - customPopover.offsetHeight;

                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));

                customPopover.style.left = `${newX}px`;
                customPopover.style.top = `${newY}px`;
            }

            function onDragMouseUp() {
                isDragging = false;
                popoverHeader.style.cursor = 'grab';
                document.body.style.userSelect = '';

                document.removeEventListener('mousemove', onDragMouseMove);
                document.removeEventListener('mouseup', onDragMouseUp);
            }

            // Initial Load
            loadTable('products', 1, perPage);
            loadTable('promotion_data', 1, perPage);

            // Event Listeners
            document.getElementById('popover-close').addEventListener('click', () => {
                customPopover.classList.remove('is-visible');
                document.querySelectorAll('tbody tr.table-primary').forEach(r => r.classList.remove('table-primary'));
            });

            productSearchBtn.addEventListener('click', () => {
                const searchTerm = productSearchInput.value.trim();
                loadTable('products', 1, perPage, searchTerm);
            });

            productSearchInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    productSearchBtn.click();
                }
            });

            productClearBtn.addEventListener('click', () => {
                productSearchInput.value = '';
                loadTable('products', 1, perPage, '');
            });

            function loadTable(tableName, page, perPage, searchTerm = '') {
                const elementIdBase = tableName.replace(/_/g, '-');
                const tableContainer = document.getElementById(`${elementIdBase}-table-container`);
                if (!tableContainer) return;

                tableContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

                let apiUrl = `/api/${tableName}?page=${page}&per_page=${perPage}`;
                if (searchTerm && tableName === 'products') {
                    apiUrl += `&search=${encodeURIComponent(searchTerm)}`;
                }

                fetch(apiUrl)
                    .then(response => response.ok ? response.json() : Promise.reject(new Error(`HTTP error! status: ${response.status}`)))
                    .then(result => {
                        const { columns, data, total_pages, error } = result;
                        const paginationContainer = document.getElementById(`${elementIdBase}-pagination`);

                        if (error) {
                            throw new Error(error);
                        }

                        if (!data || data.length === 0) {
                            if (searchTerm) {
                                tableContainer.innerHTML = `<p class="text-center text-muted p-5">未找到与 \"${escapeHtml(searchTerm)}\" 相关的商品。</p>`;
                            } else {
                                tableContainer.innerHTML = '<p class="text-center text-muted p-5">没有数据</p>';
                            }
                            paginationContainer.innerHTML = '';
                            return;
                        }

                        let tableHtml = '<table class="table table-bordered table-striped table-hover">';
                        tableHtml += '<thead class="table-dark" style="position: sticky; top: 0; z-index: 1;"><tr>';
                        const translations = columnTranslations[tableName] || {};
                        columns.forEach(col => {
                            tableHtml += `<th>${translations[col] || col.replace(/_/g, ' ')}</th>`;
                        });
                        tableHtml += '</tr></thead><tbody>';

                        data.forEach(row => {
                            tableHtml += `<tr data-date="${row.date}" data-product-id="${row.product_id}" data-promotion-id="${row.promotion_id}">`;
                            columns.forEach(col => {
                                let value = row[col];
                                if (value === null || value === undefined) value = '';

                                const formatCols = ['order_conversion_rate', 'video_sales_ratio', 'video_view_sales_ratio'];
                                if (formatCols.includes(col) && typeof value === 'number') {
                                    value = (value * 100).toFixed(2) + '%';
                                }

                                if ((col === 'cover' || col === '封面') && typeof value === 'string' && value.startsWith('http')) {
                                    value = `<a href="${value}" target="_blank" title="点击查看大图"><img src="${value}" alt="cover" height="40"></a>`;
                                } else if (typeof value === 'string' && value.startsWith('http')) {
                                    value = `<a href="${value}" target="_blank" title="${escapeHtml(value)}">${escapeHtml(value.substring(0, 30))}...</a>`;
                                } else if (typeof value === 'string' && value.length > 40) {
                                    value = `<span title="${escapeHtml(value)}">${escapeHtml(value.substring(0, 40))}...</span>`;
                                }
                                tableHtml += `<td>${value}</td>`;
                            });
                            tableHtml += '</tr>';
                        });
                        tableHtml += '</tbody></table>';
                        tableContainer.innerHTML = tableHtml;

                        buildPagination(tableName, paginationContainer, page, total_pages, perPage, searchTerm);
                        initializeRowClickListeners(tableContainer, tableName);
                    })
                    .catch(error => {
                        console.error(`Error loading ${tableName}:`, error);
                        tableContainer.innerHTML = `<p class="text-danger text-center p-5">加载数据失败: ${error.message}</p>`;
                    });
            }

            function initializeRowClickListeners(tableContainer, tableName) {
                const popoverTitle = document.getElementById('popover-title');
                const popoverBody = customPopover.querySelector('.popover-body');
                const rows = tableContainer.querySelectorAll('tbody tr');
                let chartInstance = null;

                rows.forEach(row => {
                    row.addEventListener('click', () => {
                        document.querySelectorAll('tbody tr.table-primary').forEach(r => r.classList.remove('table-primary'));
                        row.classList.add('table-primary');

                        popoverTitle.textContent = '关联数据';
                        popoverBody.innerHTML = '<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                        customPopover.classList.add('is-visible');

                        if (chartInstance) {
                            chartInstance.destroy();
                            chartInstance = null;
                        }

                        const rowData = row.dataset;
                        const targetTable = tableName === 'products' ? 'promotion_data' : 'products';
                        const targetApi = `/api/${targetTable}_item`;
                        const detailApi = `/api/promotion_data_detail`;

                        const params = new URLSearchParams({ date: rowData.date, product_id: rowData.productId, promotion_id: rowData.promotionId });

                        Promise.all([
                            fetch(`${targetApi}?${params.toString()}`).then(res => res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`))),
                            fetch(`${detailApi}?${params.toString()}`).then(res => res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`)))
                        ])
                        .then(([itemData, detailData]) => {
                            if (itemData.error) throw new Error(itemData.error);

                            // Render item details
                            let contentHtml = '<dl class="row">';
                            const itemTranslations = columnTranslations[targetTable] || {};
                            const keys = Object.keys(itemData);

                            for (const key of keys) {
                                if (key.endsWith('_formatted') || ['creation_time', 'source_json_filename', 'time_range'].includes(key)) {
                                    continue;
                                }
                                const value = itemData[key];
                                if (value === null || value === '') continue;

                                let displayValue;
                                const displayName = itemTranslations[key] || key.replace(/_/g, ' ');
                                const formattedKey = `${key}_formatted`;
                                
                                if (itemData.hasOwnProperty(formattedKey)) {
                                    const formattedValue = itemData[formattedKey] || '';
                                    if (key.includes('rate') || key.includes('ratio')) {
                                        displayValue = `${(value * 100).toFixed(2)}% (${formattedValue})`;
                                    } else {
                                        displayValue = `${value} (${formattedValue})`;
                                    }
                                } else if ((key.includes('rate') || key.includes('ratio')) && typeof value === 'number') {
                                    displayValue = (value * 100).toFixed(2) + '%';
                                } else if (typeof value === 'string' && value.startsWith('http')) {
                                    displayValue = `<a href="${value}" target="_blank">link</a>`;
                                } else {
                                    displayValue = escapeHtml(String(value));
                                }
                                
                                contentHtml += `<dt class="col-sm-4 text-truncate" title="${displayName}">${displayName}</dt><dd class="col-sm-8">${displayValue}</dd>`;
                            }
                            contentHtml += '</dl>';

                            // Add canvas for chart
                            contentHtml += '<hr/><h6 class="mt-3">推广数据详情</h6><canvas id="popover-chart"></canvas>';
                            popoverBody.innerHTML = contentHtml;
                            popoverTitle.textContent = `关联 ${targetTable.replace(/_/g, ' ')} 数据`;

                            // Render chart
                            if (detailData && detailData.length > 0) {
                                const ctx = document.getElementById('popover-chart').getContext('2d');
                                const detailTranslations = columnTranslations['promotion_data_detail'] || {};
                                
                                chartInstance = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: detailData.map(d => d.calculate_time),
                                        datasets: [{
                                            label: '销量',
                                            data: detailData.map(d => d.sales),
                                            borderColor: 'rgb(75, 192, 192)',
                                            tension: 0.1
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            tooltip: {
                                                callbacks: {
                                                    label: function(context) {
                                                        const dataIndex = context.dataIndex;
                                                        const pointData = detailData[dataIndex];
                                                        let tooltip = [];
                                                        const detailKeys = Object.keys(pointData);

                                                        for (const key of detailKeys) {
                                                            if (key.startsWith('format_') || ['calculate_time', 'creation_time', 'date', 'product_id', 'promotion_id'].includes(key)) {
                                                                continue;
                                                            }
                                                            const value = pointData[key];
                                                            const displayName = detailTranslations[key] || key.replace(/_/g, ' ');
                                                            let displayValue = value;
                                                            const formattedKey = `format_${key}`;

                                                            if (pointData.hasOwnProperty(formattedKey)) {
                                                                const formattedValue = pointData[formattedKey] || '';
                                                                if (key.includes('rate')) {
                                                                    displayValue = `${(value * 100).toFixed(2)}% (${formattedValue})`;
                                                                } else {
                                                                    displayValue = `${value} (${formattedValue})`;
                                                                }
                                                            } else if (key.includes('rate') && typeof value === 'number') {
                                                                displayValue = (value * 100).toFixed(2) + '%';
                                                            }
                                                            
                                                            tooltip.push(`${displayName}: ${displayValue}`);
                                                        }
                                                        return tooltip;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                });
                            } else {
                                document.getElementById('popover-chart').outerHTML = '<p class="text-muted text-center">无推广数据详情</p>';
                            }
                        })
                        .catch(err => {
                            popoverTitle.textContent = '错误';
                            popoverBody.innerHTML = `<div class="text-danger p-3">加载失败: ${err.message}</div>`;
                        });
                    });
                });
            }

            function buildPagination(tableName, container, currentPage, totalPages, perPage, searchTerm = '') {
                container.innerHTML = '';
                if (totalPages <= 1) return;
                const ul = document.createElement('ul');
                ul.className = 'pagination';
                const createPageItem = (text, pageNum, isDisabled = false, isActive = false) => {
                    const li = document.createElement('li');
                    li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.innerText = text;
                    if (!isDisabled) {
                        a.addEventListener('click', (e) => { e.preventDefault(); loadTable(tableName, pageNum, perPage, searchTerm); });
                    }
                    li.appendChild(a);
                    return li;
                };
                ul.appendChild(createPageItem('上一页', currentPage - 1, currentPage === 1));
                let startPage = Math.max(1, currentPage - 2), endPage = Math.min(totalPages, currentPage + 2);
                if (startPage > 1) {
                    ul.appendChild(createPageItem('1', 1));
                    if (startPage > 2) ul.appendChild(createPageItem('...', 0, true));
                }
                for (let i = startPage; i <= endPage; i++) {
                    ul.appendChild(createPageItem(i, i, false, i === currentPage));
                }
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) ul.appendChild(createPageItem('...', 0, true));
                    ul.appendChild(createPageItem(totalPages, totalPages));
                }
                ul.appendChild(createPageItem('下一页', currentPage + 1, currentPage === totalPages));
                container.appendChild(ul);
            }

            function escapeHtml(unsafe) {
                if (unsafe === null || unsafe === undefined) return '';
                return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html>